<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>Upload your files</title>
		<link rel="stylesheet" href="/media/base.css" type="text/css" media="screen" title="" charset="utf-8">
		<style type="text/css" media="screen">
		    body {
		        background:#eee;
		    }
    		#path-tree { padding:0; }
    		#path-tree span { 
                color:#666;
                padding:0;
            }
		</style>
		
		<script src="/media/js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="/media/js/uploadify/swfobject.js" type="text/javascript" charset="utf-8"></script>
		<script src="/media/js/uploadify/jquery.uploadify.v2.1.0.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="/media/js/jquery-airship.js" type="text/javascript" charset="utf-8"></script>
		
		<script type="text/javascript" charset="utf-8">
		
			var humanize_bytes = function(b) 
			{
				var d = [' B', ' KB', ' MB', ' GB'];
			    for (var i = 0; b > 1024; i++) {
			    	b /= 1024;
			    }
				return Math.round(b * 100) / 100 + d[i];
			};
		
		
			$(function() {
			    
			    var uploadRelativePath = '/Files/Images'
			    
			    // files are uploading here...
			    $('#relativePath').val(uploadRelativePath);
			    // display destination
			    var pt = uploadRelativePath.split('/')
			    for (i = 1; i < pt.length; i++) {
			        
                    if (i == pt.length - 1) {
			            $('#path-tree').append($('<b />').text(pt[i]));
		            } else {
		                $('#path-tree').append($('<span />').text(pt[i]));
		            }
			        if (i < pt.length - 1) {
			            $('#path-tree').append('<span> &gt; </span>');
			        }
			    }
			    
                $('a[href=#toggle]').click(function() {
             
                    $('#basic').toggle();
                    $('#advanced').toggle();
         
                    return false;
                });


                $('#uploader').uploadify({
                    uploader: '/media/js/uploadify/uploadify.swf',
                    script: '/__/file/upload/',
                    checkScript: '/__/file/exists/',
                    scriptData: {'relativePath': uploadRelativePath}, // additional post vars
                    cancelImg: '/media/js/uploadify/cancel.png',
                    fileDataName: 'Filedata', // post name
                    folder: uploadRelativePath.substr(1),
                    multi: true,
                    auto: true,
                    buttonText: 'Choose files to upload...',
                    width: '120',
                    
                    
                    onInit: function() {
                        $('#basic').toggle();
                        $('#advanced').toggle();
                    },

                    onSelect: function(event, queueID, fileObj) {
                        
                        
                        var item = $('<div class="item">').attr('id', queueID);
                        
                        
                        item.append(
                            $('<div />').addClass('file').text(fileObj.name)
                        );
                        
                        item.append(
                            $('<div />').addClass('progress').append(
                                $('<div />').addClass('percentage')
                            )
                        );
                        
                        item.append(
                            $('<div />').addClass('cancel').click(function() {
                               $('#uploader').uploadifyCancel($(this).parent().attr('id')) 
                            })
                        );
                        
                        item.append(
                            $('<div />').addClass('status').append(
                                $('<span>Zero KB</span> of ' + humanize_bytes(fileObj.size) + '<span class="mode">Waiting to upload...</span>'))
                        );
                        
                    
                    
                        $('#queue').append(item);
                        $('#upload-count').html($('#queue .item').length);
                 
                        return false;
                     },
                     onCancel: function(event, queueID, fileObj, data) {
                         $('#' + queueID).remove();
                         $('#upload-count').html($('#queue .item').length);
                     },
             
                     onProgress: function(event, queueID, fileObj, data) {
                         
                     
                        $('#' + queueID).addClass('active').find('.percentage').css('width', (data.percentage * 4) + 'px');
                        $('#' + queueID).find('.status span').eq(0).html(humanize_bytes(data.bytesLoaded));
                        $('#' + queueID).find('.status .mode').html('Uploading...');
                     },

                     onComplete: function(event, queueID, fileObj, response, data) {
                         
                         $('#' + queueID).addClass('complete')
                            .find('.mode').html('Upload complete');

                         $('#upload-count-completed').html($('#queue .complete').length);
                         
                         if (window.opener.a) {
                             
                             var pw = window.opener.a;
                             if (pw.currentRelativePath() == uploadRelativePath) {
                                 
                                 console.log('insert a new row into the window...')
                                 pw.insertItemRow('margle', '1235');
                                 
                             }
                         }
                         
                     },
                     
                     onAllComplete: function(filesUploaded, errors, allBytesLoaded, speed)
                     {
                         // filesUploaded – The total number of files uploaded
                         // errors – The total number of errors while uploading
                         // allBytesLoaded – The total number of bytes uploaded
                         // speed – The average speed of all uploaded files
                         
                     },
                     
                     onCheck: function(event, checkScript, fileQueueObj, folder, single)
                     {
                     }
                 });

							
							
			});
		</script>
	</head>
	<body>
		
		<div id="upload-container">

			<h2>Upload your files</h2>
			<p>You're uploading to <span id="path-tree"></span></p>

			<form action="/__/file/upload/" method="post" enctype="multipart/form-data" id="basic">
				
				<p>
					<input type="file" name="Filedata"><br>
					<span class="small">Problems? Try the <a href="#toggle">advanced uploader</a>.</span>
				</p>
				
				<p>
					<input type="submit" value="Upload">
					<input type="hidden" name="relativePath" id="relativePath" value="Files">
				</p>
			</form>

				
				
			<div id="advanced">
				
				<div id="uploader"></div>
				
				<p class="small">Problems? Try the <a href="#toggle">basic uploader</a>.</p>
				
				<div id="queue">
				</div>
				
				<p><span id="upload-count-completed">0</span> of <span id="upload-count">0</span> files uploaded.</p>
				
			</div>
				
				
				
			
			
		</div>
	</body>
</html>